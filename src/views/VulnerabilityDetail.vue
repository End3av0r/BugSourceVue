<template>
  <div class="vulnerability-detail">
    <a-page-header
      style="border: 1px solid rgb(235, 237, 240)"
      title="漏洞详情"
      @back="goBack"
    />
    
    <a-spin :spinning="loading">
      <a-card :bordered="false" v-if="vulnerability">
        <a-descriptions title="基本信息" bordered>
          <a-descriptions-item label="漏洞标题" :span="3">
            {{ vulnerability.cnTitle }}
          </a-descriptions-item>
          <a-descriptions-item label="CNVD编号">
            {{ vulnerability.cnvdId }}
          </a-descriptions-item>
          <a-descriptions-item label="CVE编号">
            {{ vulnerability.cveId }}
          </a-descriptions-item>
          <a-descriptions-item label="发布时间">
            {{ vulnerability.pubDate }}
          </a-descriptions-item>
          <a-descriptions-item label="危害等级">
            <a-tag :color="getHazardLevelColor(vulnerability.hazardLevel)">
              {{ vulnerability.hazardLevel }}
            </a-tag>
          </a-descriptions-item>
          <a-descriptions-item label="漏洞类型">
            {{ vulnerability.cnTypes }}
          </a-descriptions-item>
          <a-descriptions-item label="标签" :span="1">
            <a-space>
              <a-tag v-for="tag in vulnerability.tag" :key="tag" color="blue">{{ tag }}</a-tag>
            </a-space>
          </a-descriptions-item>
        </a-descriptions>
        
        <a-divider />
        
        <a-typography>
          <a-typography-title :level="4">漏洞描述</a-typography-title>
          <a-typography-paragraph>
            {{ vulnerability.cnDescribe }}
          </a-typography-paragraph>
          
          <a-typography-title :level="4">影响范围</a-typography-title>
          <a-typography-paragraph>
            {{ vulnerability.cnImpact }}
          </a-typography-paragraph>
          
          <a-typography-title :level="4">解决方案</a-typography-title>
          <a-typography-paragraph>
            {{ vulnerability.cnSolution }}
          </a-typography-paragraph>
          
          <a-typography-title :level="4">补丁信息</a-typography-title>
          <a-typography-paragraph>
            {{ vulnerability.cnPatch || '暂无补丁信息' }}
          </a-typography-paragraph>
          
          <a-typography-title :level="4">参考链接</a-typography-title>
          <a-typography-paragraph>
            <a :href="vulnerability.cnReference" target="_blank" v-if="vulnerability.cnReference">
              {{ vulnerability.cnReference }}
            </a>
            <span v-else>暂无参考链接</span>
          </a-typography-paragraph>
        </a-typography>
      </a-card>
    </a-spin>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { getVulnerabilityById } from '../api/vulnerability'

const route = useRoute()
const router = useRouter()
const loading = ref(true)
const vulnerability = ref(null)

// 获取危害等级对应的颜色
const getHazardLevelColor = (level) => {
  const colors = {
    '高': 'red',
    '中': 'orange',
    '低': 'green',
    '未知': 'blue'
  }
  return colors[level] || 'blue'
}

// 返回上一页
const goBack = () => {
  router.back()
}

// 加载漏洞详情
const loadVulnerabilityDetail = async () => {
  loading.value = true
  try {
    const id = route.params.id
    const response = await getVulnerabilityById(id)
    
    if (response.data && response.data.code === '0000') {
      vulnerability.value = response.data.data
    }
  } catch (error) {
    console.error('加载漏洞详情失败:', error)
    // 使用模拟数据
    vulnerability.value = {
      id: route.params.id,
      cnvdId: 'CNVD-2025-10001',
      cveId: 'CVE-2025-5001',
      cnTitle: '示例漏洞详情标题',
      pubDate: '2025-09-01',
      hazardLevel: '高危',
      cnTypes: 'SQL注入',
      tag: ['SQL注入', 'Web应用'],
      cnDescribe: '这是一个示例漏洞描述。该漏洞允许攻击者通过构造特殊的SQL语句，绕过应用程序的安全检查，直接访问或操作数据库，可能导致未授权数据访问、数据泄露或数据损坏。',
      cnImpact: '影响使用该组件的所有Web应用程序版本1.0-2.5。',
      cnSolution: '升级到最新版本3.0或应用官方提供的安全补丁。同时，建议实施参数化查询和输入验证等安全措施。',
      cnPatch: '官方已发布3.0版本修复了该问题，建议受影响用户及时升级。',
      cnReference: 'https://example.com/security/advisory/2025-001'
    }
  } finally {
    loading.value = false
  }
}

onMounted(() => {
  loadVulnerabilityDetail()
})
</script>

<style scoped>
.vulnerability-detail {
  padding: 0 12px;
}
</style>