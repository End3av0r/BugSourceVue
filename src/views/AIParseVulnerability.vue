<template>
  <div class="ai-parse-container">
    <a-card title="AI漏洞信息解析" :bordered="false" class="main-card">
      <template #extra>
        <a-tag color="blue">
          <template #icon>
            <RobotOutlined />
          </template>
          智能解析
        </a-tag>
      </template>

      <!-- 输入区域 -->
      <div class="input-section">
        <a-row :gutter="[24, 24]">
          <a-col :xs="24" :lg="12">
            <div class="input-panel">
              <h3>输入Markdown文本</h3>
              
              <!-- 文件上传区域 -->
              <div class="upload-section">
                <a-upload-dragger
                  :file-list="fileList"
                  :before-upload="beforeUpload"
                  :remove="removeFile"
                  accept=".md,.txt,.markdown"
                  :multiple="false"
                  :disabled="loading"
                  class="upload-dragger"
                >
                  <p class="ant-upload-drag-icon">
                    <InboxOutlined />
                  </p>
                  <p class="ant-upload-text">点击或拖拽文件到此区域上传</p>
                  <p class="ant-upload-hint">
                    支持 .md、.txt、.markdown 格式文件，文件大小不超过 10MB
                  </p>
                </a-upload-dragger>
              </div>

              <!-- 分隔线 -->
              <a-divider>或</a-divider>

              <!-- 文本输入区域 -->
              <a-textarea
                v-model:value="markdownText"
                :rows="15"
                placeholder="请在此处粘贴或输入漏洞信息的Markdown文本..."
                :disabled="loading"
                class="markdown-input"
              />
              
              <div class="input-actions">
                <a-space>
                  <a-button 
                    type="primary" 
                    @click="parseWithAI" 
                    :loading="loading"
                    :disabled="!markdownText.trim()"
                    size="large"
                  >
                    <template #icon>
                      <RobotOutlined />
                    </template>
                    AI智能解析
                  </a-button>
                  <a-button @click="clearInput" :disabled="loading">
                    清空内容
                  </a-button>
                  <a-button @click="loadSample" :disabled="loading">
                    加载示例
                  </a-button>
                </a-space>
              </div>
            </div>
          </a-col>

          <a-col :xs="24" :lg="12">
            <div class="preview-panel">
              <h3>Markdown预览</h3>
              <div class="markdown-preview" v-html="renderedMarkdown"></div>
            </div>
          </a-col>
        </a-row>
      </div>

      <!-- 解析结果区域 -->
      <div v-if="parseResult" class="result-section">
        <a-divider>
          <CheckCircleOutlined style="color: #52c41a; font-size: 16px;" />
          解析结果（可编辑）
        </a-divider>

        <a-row :gutter="[24, 24]">
          <a-col :span="24">
            <a-card title="漏洞基本信息" :bordered="false" class="result-card">
              <a-form layout="vertical">
                <a-row :gutter="16">
                  <a-col :span="24">
                    <a-form-item label="漏洞标题">
                      <a-input v-model:value="parseResult.cnTitle" placeholder="请输入漏洞标题" />
                    </a-form-item>
                  </a-col>
                </a-row>

                <a-row :gutter="16">
                  <a-col :span="8">
                    <a-form-item label="发布日期">
                      <a-input v-model:value="parseResult.pubDate" placeholder="YYYY-MM-DD" />
                    </a-form-item>
                  </a-col>
                  <a-col :span="8">
                    <a-form-item label="CNVD ID">
                      <a-input v-model:value="parseResult.cnvdId" placeholder="请输入CNVD ID" />
                    </a-form-item>
                  </a-col>
                  <a-col :span="8">
                    <a-form-item label="CVE ID">
                      <a-input v-model:value="parseResult.cveId" placeholder="请输入CVE ID" />
                    </a-form-item>
                  </a-col>
                </a-row>

                <a-row :gutter="16">
                  <a-col :span="12">
                    <a-form-item label="威胁等级">
                      <a-select v-model:value="parseResult.hazardLevel" placeholder="请选择威胁等级">
                        <a-select-option value="高">高危</a-select-option>
                        <a-select-option value="中">中危</a-select-option>
                        <a-select-option value="低">低危</a-select-option>
                      </a-select>
                    </a-form-item>
                  </a-col>
                  <a-col :span="12">
                    <a-form-item label="漏洞类型">
                      <a-input v-model:value="parseResult.cnTypes" placeholder="请输入漏洞类型" />
                    </a-form-item>
                  </a-col>
                </a-row>

                <a-row :gutter="16">
                  <a-col :span="24">
                    <a-form-item label="影响产品">
                      <a-textarea v-model:value="parseResult.cnImpact" :rows="2" placeholder="请输入影响产品信息" />
                    </a-form-item>
                  </a-col>
                </a-row>

                <a-row :gutter="16">
                  <a-col :span="24">
                    <a-form-item label="漏洞描述">
                      <a-textarea v-model:value="parseResult.cnDescribe" :rows="4" placeholder="请输入漏洞描述" />
                    </a-form-item>
                  </a-col>
                </a-row>

                <a-row :gutter="16">
                  <a-col :span="24">
                    <a-form-item label="解决方案">
                      <a-textarea v-model:value="parseResult.cnSolution" :rows="4" placeholder="请输入解决方案" />
                    </a-form-item>
                  </a-col>
                </a-row>
              </a-form>
            </a-card>
          </a-col>
        </a-row>

        <!-- 操作按钮 -->
        <div class="result-actions">
          <a-space>
            <a-button type="primary" @click="saveVulnerability" :loading="saving">
              <template #icon>
                <SaveOutlined />
              </template>
              保存到数据库
            </a-button>
            <a-button @click="copyResult">
              <template #icon>
                <CopyOutlined />
              </template>
              复制结果
            </a-button>
            <a-button @click="resetResult">
              重新解析
            </a-button>
          </a-space>
        </div>
      </div>

      <!-- 加载状态 -->
      <div v-if="loading" class="loading-overlay">
        <a-spin size="large">
          <template #indicator>
            <LoadingOutlined style="font-size: 24px" spin />
          </template>
          <div class="loading-text">AI正在解析中，请稍候...</div>
        </a-spin>
      </div>
    </a-card>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { message } from 'ant-design-vue'
import { 
  RobotOutlined, 
  CheckCircleOutlined, 
  SaveOutlined, 
  CopyOutlined,
  LoadingOutlined,
  InboxOutlined
} from '@ant-design/icons-vue'
import { parseMarkdownOnly, saveVulnerability as saveVulnAPI } from '../api/vulnerability'
import MarkdownIt from 'markdown-it'

// 响应式数据
const markdownText = ref('')
const loading = ref(false)
const saving = ref(false)
const parseResult = ref(null)
const fileList = ref([])

// Markdown渲染器
const md = new MarkdownIt({
  html: true,
  linkify: true,
  typographer: true
})

// 计算属性：渲染的Markdown
const renderedMarkdown = computed(() => {
  if (!markdownText.value.trim()) {
    return '<p class="empty-preview">请输入Markdown文本以查看预览</p>'
  }
  return md.render(markdownText.value)
})

// 威胁等级颜色映射
const getThreatLevelColor = (level) => {
  const colorMap = {
    '严重': 'red',
    '高危': 'volcano', 
    '中危': 'orange',
    '低危': 'green',
    '信息': 'blue'
  }
  return colorMap[level] || 'default'
}

// 示例数据
const sampleMarkdown = `# CVE-2024-1234 示例漏洞

**CNVD ID**: CNVD-2024-12345  
**CVE ID**: CVE-2024-1234  
**发布日期**: 2024-01-15  
**威胁等级**: 高危  
**漏洞类型**: 代码注入  

## 漏洞描述

这是一个示例漏洞描述，用于演示AI解析功能。该漏洞存在于某个Web应用程序中，攻击者可以通过构造特殊的输入来执行任意代码。

## 影响产品

- 产品名称: 示例Web应用
- 版本范围: 1.0.0 - 2.0.0

## 漏洞详情

攻击者可以通过向应用程序发送恶意构造的HTTP请求来利用此漏洞。具体来说，应用程序在处理用户输入时没有进行充分的验证和过滤。

## 解决方案

1. 升级到最新版本
2. 对用户输入进行严格的验证和过滤
3. 实施输入长度限制
4. 使用参数化查询防止SQL注入`

// 方法
const parseWithAI = async () => {
  if (!markdownText.value.trim()) {
    message.warning('请输入Markdown文本')
    return
  }

  loading.value = true
  try {
    const response = await parseMarkdownOnly(markdownText.value)

    if (response.data.code === '0000') {
      parseResult.value = response.data.data
      message.success('AI解析完成！请检查结果后点击"保存到数据库"按钮')
    } else {
      message.error(response.data.info || '解析失败')
    }
  } catch (error) {
    console.error('解析失败:', error)
    message.error('解析失败，请检查网络连接或联系管理员')
  } finally {
    loading.value = false
  }
}

const clearInput = () => {
  markdownText.value = ''
  parseResult.value = null
  fileList.value = []
}

// 文件上传前验证
const beforeUpload = (file) => {
  const isValidType = file.type === 'text/plain' || 
                     file.name.endsWith('.md') || 
                     file.name.endsWith('.txt') || 
                     file.name.endsWith('.markdown')
  
  if (!isValidType) {
    message.error('只支持 .md、.txt、.markdown 格式的文件！')
    return false
  }

  const isLt10M = file.size / 1024 / 1024 < 10
  if (!isLt10M) {
    message.error('文件大小不能超过 10MB！')
    return false
  }

  // 清空之前的文件列表
  fileList.value = []
  
  // 读取文件内容
  const reader = new FileReader()
  reader.onload = (e) => {
    markdownText.value = e.target.result
    // 将文件添加到文件列表中以显示文件名
    fileList.value = [{
      uid: file.uid,
      name: file.name,
      status: 'done',
      size: file.size,
      type: file.type
    }]
    message.success('文件上传成功！')
  }
  reader.onerror = () => {
    message.error('文件读取失败！')
  }
  reader.readAsText(file, 'UTF-8')

  return false // 阻止自动上传，我们手动处理
}

// 移除文件
const removeFile = (file) => {
  const index = fileList.value.indexOf(file)
  if (index > -1) {
    fileList.value.splice(index, 1)
  }
  // 如果移除的是当前文件，清空文本内容
  if (fileList.value.length === 0) {
    markdownText.value = ''
  }
  return true
}

const loadSample = () => {
  markdownText.value = sampleMarkdown
}

const saveVulnerability = async () => {
  if (!parseResult.value) {
    message.warning('没有可保存的解析结果')
    return
  }

  saving.value = true
  try {
    const response = await saveVulnAPI(parseResult.value)

    if (response.data.code === '0000') {
      message.success('漏洞信息已成功保存到数据库！')
    } else {
      message.error(response.data.info || '���存失败')
    }
  } catch (error) {
    console.error('保存失败:', error)
    message.error('保存失败，请重试')
  } finally {
    saving.value = false
  }
}

const copyResult = () => {
  if (!parseResult.value) {
    message.warning('没有可复制的结果')
    return
  }

  const resultText = JSON.stringify(parseResult.value, null, 2)
  navigator.clipboard.writeText(resultText).then(() => {
    message.success('结果已复制到剪贴板')
  }).catch(() => {
    message.error('复制失败')
  })
}

const resetResult = () => {
  parseResult.value = null
  message.info('已重置，可以重新解析')
}

onMounted(() => {
  // 组件挂载时的初始化逻辑
})
</script>

<style scoped>
.ai-parse-container {
  padding: 24px;
  background-color: #fafafa;
  min-height: 100vh;
}

.main-card {
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.input-section {
  margin-bottom: 32px;
}

.input-panel,
.preview-panel {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.upload-section {
  margin-bottom: 16px;
}

.upload-dragger {
  border-radius: 6px;
  background: #fafafa;
  border: 2px dashed #d9d9d9;
  transition: all 0.3s ease;
}

.upload-dragger:hover {
  border-color: #1890ff;
  background: #f0f8ff;
}

.upload-dragger .ant-upload-drag-icon {
  font-size: 48px;
  color: #1890ff;
  margin-bottom: 16px;
}

.upload-dragger .ant-upload-text {
  font-size: 16px;
  color: #262626;
  margin-bottom: 8px;
}

.upload-dragger .ant-upload-hint {
  font-size: 14px;
  color: #8c8c8c;
}

.input-panel h3,
.preview-panel h3 {
  margin-bottom: 16px;
  color: #262626;
  font-weight: 600;
}

.markdown-input {
  flex: 1;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 14px;
  line-height: 1.6;
  border-radius: 6px;
  resize: vertical;
}

.input-actions {
  margin-top: 16px;
  text-align: center;
}

.markdown-preview {
  flex: 1;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
  padding: 16px;
  background: #fff;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.6;
}

.markdown-preview :deep(h1),
.markdown-preview :deep(h2),
.markdown-preview :deep(h3) {
  margin-top: 0;
  margin-bottom: 16px;
  color: #262626;
}

.markdown-preview :deep(p) {
  margin-bottom: 12px;
}

.markdown-preview :deep(code) {
  background: #f5f5f5;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.markdown-preview :deep(pre) {
  background: #f5f5f5;
  padding: 12px;
  border-radius: 6px;
  overflow-x: auto;
}

.empty-preview {
  color: #999;
  text-align: center;
  margin-top: 50px;
}

.result-section {
  margin-top: 32px;
}

.result-card {
  border-radius: 6px;
  border: 1px solid #e8e8e8;
}

.description-text,
.detail-text,
.solution-text {
  max-height: 200px;
  overflow-y: auto;
  padding: 8px;
  background: #fafafa;
  border-radius: 4px;
  white-space: pre-wrap;
  word-break: break-word;
}

.result-actions {
  margin-top: 24px;
  text-align: center;
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  border-radius: 8px;
}

.loading-text {
  margin-top: 16px;
  color: #666;
  font-size: 16px;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .ai-parse-container {
    padding: 16px;
  }
  
  .markdown-input {
    font-size: 12px;
  }
  
  .markdown-preview {
    font-size: 12px;
  }
}

/* 自定义描述列表样式 */
:deep(.ant-descriptions-item-label) {
  font-weight: 600;
  background-color: #fafafa;
}

:deep(.ant-descriptions-item-content) {
  background-color: #fff;
}

:deep(.ant-tag) {
  margin-right: 0;
}
</style>
